<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Analysing or debugging a simulation &#8212; OpenFisca  documentation</title>
    
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/scripts.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Openfisca Python API" href="../openfisca-python-api/index.html" />
    <link rel="prev" title="How to run a simulation" href="run-simulation.html" />
  
   

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../openfisca-python-api/index.html" title="Openfisca Python API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="run-simulation.html" title="How to run a simulation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../summary.html">OpenFisca  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Running a simulation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
      ../index.html" class="text-logo">OpenFisca</a>

<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>

<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key-concepts/index.html">Key concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coding-the-legislation/index.html">From law to code</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Running a simulation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="run-simulation.html">How to run a simulation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Analysing or debugging a simulation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../openfisca-python-api/index.html">Openfisca Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openfisca-web-api/index.html">OpenFisca Web API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../recipes/index.html">Installation recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publishing.html">Publishing results based on OpenFisca</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
</ul>

    
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../summary.html">Docs</a></li>
              
                <li><a href="index.html">Running a simulation</a></li>
              
              <li>Analysing or debugging a simulation</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="analysing-or-debugging-a-simulation">
<span id="analysing-or-debugging-a-simulation"></span><h1>Analysing or debugging a simulation<a class="headerlink" href="#analysing-or-debugging-a-simulation" title="Permalink to this headline">¶</a></h1>
<p>When running a simulation with the Python API, you might want to understand how the result was calculated and what intermediate variables and parameters have been taken into account.</p>
<blockquote>
<div>To trace a simulation calculation with the Web API, please see <a class="reference internal" href="../openfisca-web-api/trace-simulation.html"><span class="doc">/trace endpoint documentation</span></a>.</div></blockquote>
<div class="section" id="activating-the-simulation-tracer">
<span id="activating-the-simulation-tracer"></span><h2>Activating the simulation tracer<a class="headerlink" href="#activating-the-simulation-tracer" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s suppose you ran a simulation, calculated the <code class="docutils literal"><span class="pre">housing_allowance</span></code> for a set of households, and would like to understand in details where the final results come from.</p>
<p>To use the tracer, you should activate the <code class="docutils literal"><span class="pre">trace</span></code> option with <code class="docutils literal"><span class="pre">simulation.trace</span> <span class="pre">=</span> <span class="pre">True</span></code> <em>before</em> running any calculation with a <code class="docutils literal"><span class="pre">simulation</span></code> object. This will allow you to inspect calculation steps and print them with <code class="docutils literal"><span class="pre">simulation.tracer.print_computation_log()</span></code>.</p>
<p>Here is an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">openfisca_core.simulation_builder</span> <span class="kn">import</span> <span class="n">SimulationBuilder</span>
<span class="kn">from</span> <span class="nn">openfisca_country_template</span> <span class="kn">import</span> <span class="n">CountryTaxBenefitSystem</span>

<span class="n">TEST_CASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># ... whole test case (see example in next section)...</span>
<span class="p">}</span>

<span class="n">tax_benefit_system</span> <span class="o">=</span> <span class="n">CountryTaxBenefitSystem</span><span class="p">()</span>
<span class="n">simulation_builder</span> <span class="o">=</span> <span class="n">SimulationBuilder</span><span class="p">()</span>
<span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation_builder</span><span class="o">.</span><span class="n">build_from_entities</span><span class="p">(</span><span class="n">tax_benefit_system</span><span class="p">,</span> <span class="n">TEST_CASE</span><span class="p">)</span>

<span class="c1"># activate the trace</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># calculate a variable</span>
<span class="n">housing_allowance</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="s1">&#39;housing_allowance&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01&#39;</span><span class="p">)</span>

<span class="c1"># print calculation steps</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">print_computation_log</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div>For more information on the <code class="docutils literal"><span class="pre">tracer</span></code> methods, see this <a class="reference external" href="../openfisca-python-api/tracer.html">Tracer class interface</a></div></blockquote>
</div>
<div class="section" id="analysing-simulation-steps">
<span id="analysing-simulation-steps"></span><h2>Analysing simulation steps<a class="headerlink" href="#analysing-simulation-steps" title="Permalink to this headline">¶</a></h2>
<p>If we use the tracer with the following <code class="docutils literal"><span class="pre">TEST_CASE</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;persons&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Ari&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;salary&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;2011-01&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>
        <span class="p">},</span> 
        <span class="s1">&#39;Paul&#39;</span><span class="p">:</span> <span class="p">{},</span> 
        <span class="s1">&#39;Leila&#39;</span><span class="p">:</span> <span class="p">{},</span> 
        <span class="s1">&#39;Javier&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="s1">&#39;households&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Leila&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ari&#39;</span><span class="p">,</span> <span class="s1">&#39;Paul&#39;</span><span class="p">],</span>
            <span class="s1">&#39;rent&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;2011-01&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Javier&#39;</span><span class="p">]}</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The previous code example would give us this output:</p>
<div class="highlight-py"><div class="highlight"><pre><span></span>  <span class="n">housing_allowance</span><span class="o">&lt;</span><span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">&gt;</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="mf">75.</span>  <span class="mf">0.</span><span class="p">]</span>
    <span class="n">rent</span><span class="o">&lt;</span><span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">&gt;</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="mf">300.</span>   <span class="mf">0.</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">rent</span></code> variable is indented to the right relative to <code class="docutils literal"><span class="pre">housing_allowance</span></code>. This says that <code class="docutils literal"><span class="pre">housing_allowance</span></code> variable called the <code class="docutils literal"><span class="pre">rent</span></code> calculation. It was called on the same period, &#8216;2011-01&#8217;. As the <a class="reference external" href="https://demo.openfisca.org/legislation/rent">rent variable</a>&#8216;s value was an input value given by our <code class="docutils literal"><span class="pre">TEST_CASE</span></code>, it was returned to <code class="docutils literal"><span class="pre">housing_allowance</span></code>. Then, as the <a class="reference external" href="https://demo.openfisca.org/legislation/housing_allowance">housing_allowance variable</a> has a valid formula on &#8216;2011-01&#8217;, it used the <code class="docutils literal"><span class="pre">rent</span></code> value to calculate its amount for its two households (<code class="docutils literal"><span class="pre">h1</span></code> and <code class="docutils literal"><span class="pre">h2</span></code>): <code class="docutils literal"><span class="pre">[75.</span> <span class="pre">0.]</span></code></p>
<p>Thus, on the left side of the double chevrons, you can read the trace from top to bottom to see the dependencies between the variables. And, on the right side, you can read it from bottom to top to see how the simulation result is built.</p>
<p>Likewise if you are calculating this <code class="docutils literal"><span class="pre">housing_allowance</span></code> on a large population, you will be able to check your calculation results with aggregated outputs. To do so, you can add the <code class="docutils literal"><span class="pre">aggregate=True</span></code> option as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">simulation</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">print_computation_log</span><span class="p">(</span><span class="n">aggregate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If we apply it to our previous short example, it would give us this output:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>  housing_allowance&lt;<span class="m">2011</span>-01&gt; &gt;&gt; <span class="o">{</span><span class="s1">&#39;min&#39;</span>: <span class="m">0</span>.0, <span class="s1">&#39;max&#39;</span>: <span class="m">75</span>.0, <span class="s1">&#39;avg&#39;</span>: <span class="m">37</span>.5<span class="o">}</span>
    rent&lt;<span class="m">2011</span>-01&gt; &gt;&gt; <span class="o">{</span><span class="s1">&#39;min&#39;</span>: <span class="m">0</span>.0, <span class="s1">&#39;max&#39;</span>: <span class="m">300</span>.0, <span class="s1">&#39;avg&#39;</span>: <span class="m">150</span>.0<span class="o">}</span>
</pre></div>
</div>
<p>where the minimum, maximum, and average value is given for each computed vector.</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="run-simulation.html" title="previous chapter (use the left arrow)">How to run a simulation</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../openfisca-python-api/index.html" title="next chapter (use the right arrow)">Openfisca Python API</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../openfisca-python-api/index.html" title="Openfisca Python API"
             >next</a> |</li>
        <li class="right" >
          <a href="run-simulation.html" title="How to run a simulation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../summary.html">OpenFisca  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Running a simulation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018, contact@openfisca.org. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>
<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Vectorial computing | OpenFisca</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../coding-the-legislation/35_periods.html" />
    
    
    <link rel="prev" href="../coding-the-legislation/20_input_variables.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.3"
        data-chapter-title="Vectorial computing"
        data-filepath="coding-the-legislation/25_vectorial_computing.md"
        data-basepath=".."
        data-revision="Fri Jun 15 2018 04:27:51 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
                
                <li>
                    <a href="https://openfisca.org/doc" target="blank" class="custom-link">OpenFisca website</a>
                </li>
            
            

            
            <li class="divider"></li>
            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="key-concepts.html">
            
                
                    <a href="../key-concepts.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Key concepts
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="tax_and_benefit_system.html">
            
                
                    <a href="../tax_and_benefit_system.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Tax and Benefit System
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="variables.html">
            
                
                    <a href="../variables.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Variables
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="parameters.html">
            
                
                    <a href="../parameters.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Parameters
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="person,_entities,_role.html">
            
                
                    <a href="../person,_entities,_role.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Person, entities, role
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="periodsinstants.html">
            
                
                    <a href="../periodsinstants.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Periods, Instants
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="input_data.html">
            
                
                    <a href="../input_data.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                        Input Data
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="simulation.html">
            
                
                    <a href="../simulation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                        Simulation, Computation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="reforms.html">
            
                
                    <a href="../reforms.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                        Reforms
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="coding-the-legislation/index.html">
            
                
                    <a href="../coding-the-legislation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        From law to code
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="coding-the-legislation/10_basic_example.html">
            
                
                    <a href="../coding-the-legislation/10_basic_example.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Coding a formula: basic example
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="coding-the-legislation/20_input_variables.html">
            
                
                    <a href="../coding-the-legislation/20_input_variables.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Introducing an input variable
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.3" data-path="coding-the-legislation/25_vectorial_computing.html">
            
                
                    <a href="../coding-the-legislation/25_vectorial_computing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Vectorial computing
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="coding-the-legislation/35_periods.html">
            
                
                    <a href="../coding-the-legislation/35_periods.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Periods
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="coding-the-legislation/40_legislation_evolutions.html">
            
                
                    <a href="../coding-the-legislation/40_legislation_evolutions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Legislation evolutions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="coding-the-legislation/50_entities.html">
            
                
                    <a href="../coding-the-legislation/50_entities.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        Entities
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="coding-the-legislation/reforms.html">
            
                
                    <a href="../coding-the-legislation/reforms.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                        Reforms
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="coding-the-legislation/inferences.html">
            
                
                    <a href="../coding-the-legislation/inferences.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                        Inferences
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="coding-the-legislation/writing_yaml_tests.html">
            
                
                    <a href="../coding-the-legislation/writing_yaml_tests.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                        Writing YAML tests
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="coding-the-legislation/legislation_parameters.html">
            
                
                    <a href="../coding-the-legislation/legislation_parameters.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                        Parameters
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="coding-the-legislation/bootstrapping_a_new_country_package.html">
            
                
                    <a href="../coding-the-legislation/bootstrapping_a_new_country_package.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.11.</b>
                        
                        Bootstrapping a new country package
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="openfisca-web-api/index.html">
            
                
                    <a href="../openfisca-web-api/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        OpenFisca Web API
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="openfisca-web-api/endpoints.html">
            
                
                    <a href="../openfisca-web-api/endpoints.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Endpoints
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="openfisca-web-api/input-output-data.html">
            
                
                    <a href="../openfisca-web-api/input-output-data.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Input and output data
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="troubleshooting.html">
            
                
                    <a href="../troubleshooting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Troubleshooting
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="recipes.html">
            
                
                    <a href="../recipes.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Recipes
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="howto-web-no-local-install.html">
            
                
                    <a href="../howto-web-no-local-install.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        Use OpenFisca on the web (no installation required on your computer)
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="howto_docker.html">
            
                
                    <a href="../howto_docker.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        Use OpenFisca with Docker
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="offline-environment.html">
            
                
                    <a href="../offline-environment.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                        Install OpenFisca in an offline environment
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="windows-no-admin.html">
            
                
                    <a href="../windows-no-admin.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                        Work on OpenFisca on a Windows without being administrator
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="test_situations.html">
            
                
                    <a href="../test_situations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.5.</b>
                        
                        Test your changes on &quot;ready to use&quot; situations
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="publishing.html">
            
                
                    <a href="../publishing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Publishing results
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="community.html">
            
                
                    <a href="../community.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Community
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="contribute/index.html">
            
                
                    <a href="../contribute/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Contribute
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1" data-path="contribute/guidelines.html">
            
                
                    <a href="../contribute/guidelines.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.</b>
                        
                        Contributor guidelines
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1.1" data-path="contribute/language.html">
            
                
                    <a href="../contribute/language.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.1.</b>
                        
                        Language
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.1.2" data-path="contribute/commit-messages.html">
            
                
                    <a href="../contribute/commit-messages.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.2.</b>
                        
                        Commit messages
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.1.3" data-path="contribute/variables-naming.html">
            
                
                    <a href="../contribute/variables-naming.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.3.</b>
                        
                        Variables naming
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.1.4" data-path="contribute/semver.html">
            
                
                    <a href="../contribute/semver.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.1.4.</b>
                        
                        Semantic versionning
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="contribute/documentation.html">
            
                
                    <a href="../contribute/documentation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.2.</b>
                        
                        Enhance the documentation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="contribute/extensions.html">
            
                
                    <a href="../contribute/extensions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.3.</b>
                        
                        Extensions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.4" data-path="contribute/developer-guide.html">
            
                
                    <a href="../contribute/developer-guide.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.4.</b>
                        
                        Developer guide
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.5" data-path="contribute/tests.html">
            
                
                    <a href="../contribute/tests.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.5.</b>
                        
                        Tests
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8.6" data-path="contribute/release-process.html">
            
                
                    <a href="../contribute/release-process.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.6.</b>
                        
                        Release process
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >OpenFisca</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="vectorial-computing">Vectorial computing</h1>
<p>OpenFisca calculation are all <strong>vectorial</strong>. That means they operate on arrays rather than single (&#x201C;scalar&#x201D;) values.</p>
<p>The practical benefit is that computations are almost as expensive for one entity as they are for hundred thousands. This is how datasets can be analysed and how reforms can be modelled accurately. However, to support this feature, you will need to apply some constraints on how you write formulas.</p>
<h2 id="formulas-always-return-vectors">Formulas always return vectors</h2>
<p>Each <a href="../variables.html#formulas">formula</a> computation in OpenFisca must return a vector.</p>
<p>For instance, for a simulation containing 3 persons whose ages are 41, 42 and 45, executing the following formula:</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(persons, period, parameters)</span>:</span>
    age = persons(<span class="hljs-string">&apos;age&apos;</span>, period)
    print(age)
    &#x2026;  <span class="hljs-comment"># do some computation and return a value</span>
</code></pre>
<p>will print <code>array([41, 42, 45])</code>.</p>
<p>This formula code will work the same if there is one Person or three or three million in the modelled situation. Formulas always receive as their first parameter an array of the <a href="50_entities.html">entity</a> on which they operate (e.g. <em>n</em> Person, Household&#x2026;) and they should return an array of the same length.</p>
<p>Most of the time, formulas will refer to other variables and NumPy will do the appropriate computation without you even noticing:</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(persons, period, parameters)</span>:</span>
    tax_rebate = parameters(period).tax_rebate  <span class="hljs-comment"># let&apos;s say this is 500</span>
    eligibility_multiplier = persons(<span class="hljs-string">&apos;eligibility_multiplier&apos;</span>, period)  <span class="hljs-comment"># and this is [2, 0, 1]: there are three Persons</span>
    <span class="hljs-keyword">return</span> eligibility_multiplier * tax_rebate  <span class="hljs-comment"># this is [1000, 0, 500]. We&apos;ve returned a vector, yay!</span>
</code></pre>
<h3 id="what-happens-if-you-dont-return-a-vector">What happens if you don&apos;t return a vector</h3>
<p>As programmers, we more often work with scalars than vectors. We thus have a tendency to write straightforward code that returns a scalar rather than a unidimensional vector (in other words, an array of length 1), and get stuck when wanting to loop over it:</p>
<pre><code class="lang-py"><span class="hljs-comment"># THIS IS NOT A VALID OPENFISCA FORMULA</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(persons, period, parameters)</span>:</span>
    tax_rebate = parameters(period).tax_rebate  <span class="hljs-comment"># let&apos;s say this is worth 500</span>
    rebate_threshold = tax_rebate * persons[<span class="hljs-number">0</span>].eligibility_multiplier  <span class="hljs-comment"># so this is 1000; see how we&apos;ve accidentally left out other Persons?</span>
    <span class="hljs-keyword">return</span> rebate_threshold  <span class="hljs-comment"># and this returns 1000. But it&apos;s not a vector!</span>
</code></pre>
<p>OpenFisca will help you notice this mistake by raising an error:</p>
<blockquote>
<p>The formula &apos;tax_rebate@2018&apos; should return a NumPy array; instead it returned &apos;1000.0&apos; of type &apos;float&apos;.</p>
</blockquote>
<p>In a similar fashion, if you expect a formula to return a boolean and forget that you will actually get an array of boolean values (one for each entity in the situation), you will receive the following safeguard error:</p>
<blockquote>
<p>ValueError: The truth value of an array with more than one element is ambiguous. Use a.any() or a.all().</p>
</blockquote>
<p>The rest of this page gives practical replacements for situations in which you get such errors.</p>
<h2 id="control-structures">Control structures</h2>
<p>Some usual control structures such as <code>if...else</code>, <code>switch</code>, and native Python logical operators such as <code>or</code> and <code>not</code> do not work with vectors. Semantically however, they all have alternatives, and the only change is in syntax.</p>
<h3 id="if--else"><code>if</code> / <code>else</code></h3>
<p>Let&apos;s say you want to write that logically reads as:</p>
<pre><code class="lang-py"><span class="hljs-comment"># THIS IS NOT A VALID OPENFISCA FORMULA</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(person, period)</span>:</span>
    salary = person(<span class="hljs-string">&apos;salary&apos;</span>, period)
    <span class="hljs-keyword">if</span> salary &lt; <span class="hljs-number">1000</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
</code></pre>
<p>This code does not work: it makes the assumption that there is always one single person, and that its salary is provided as a number, while <code>salary</code> is actually a vector of salaries that could be of any length.</p>
<p>In such a case, apply the comparison to the <em>vector</em> of salaries, which will create a vector of booleans, and then multiply it:</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(persons, period)</span>:</span>
    condition_salary = persons(<span class="hljs-string">&apos;salary&apos;</span>, period) &lt; <span class="hljs-number">1000</span>
    <span class="hljs-keyword">return</span> condition_salary * <span class="hljs-number">200</span>
</code></pre>
<p>What happens is that for every Person in <code>persons</code>, if <code>condition_salary</code> is <code>True</code> (equivalent to <code>1</code> in logical algebra), the returned value will be <code>200</code>. And if <code>condition_salary</code> is <code>False</code> (equivalent to <code>0</code>), the returned value will be <code>0</code>.</p>
<h3 id="ternaries">Ternaries</h3>
<p>Let&apos;s now write a formula that returns <code>200</code> if the Person&#x2019;s salary is lower than <code>1000</code>, and <code>100</code> otherwise.</p>
<p>The NumPy function <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html" target="_blank"><code>where</code></a> offers a simple syntax to handle these cases.</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(persons, period)</span>:</span>
    condition_salary = persons(<span class="hljs-string">&apos;salary&apos;</span>, period) &lt; <span class="hljs-number">1000</span>
    <span class="hljs-keyword">return</span> where(condition_salary, <span class="hljs-number">200</span>, <span class="hljs-number">100</span>)
</code></pre>
<p><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html" target="_blank"><code>where</code></a> takes 3 arguments: a vector of boolean values (the &#x201C;condition&#x201D;), the value to set for this element in the vector if the condition is met, and the value to set otherwise.</p>
<p>This <code>where</code> function is provided directly by NumPy. There are many other <a href="https://docs.scipy.org/doc/numpy/reference/routines.math.html#sums-products-differences" target="_blank">NumPy functions</a> provided that can be useful.</p>
<h3 id="multiples-conditions">Multiples conditions</h3>
<p>Let&apos;s consider a more complex case, where we want to attribute to a person:</p>
<ul>
<li><code>200</code> if their salary is less than <code>500</code>;</li>
<li><code>100</code> if their salary is strictly more than <code>500</code>, but less than <code>1000;</code></li>
<li><code>50</code> if their salary is strictly more than <code>1000</code>, but less than <code>1500;</code></li>
<li><code>0</code> otherwise.</li>
</ul>
<p>We can use the NumPy function <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.select.html" target="_blank"><code>select</code></a> to implement this behaviour:</p>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(person, period)</span>:</span>
    salary = person(<span class="hljs-string">&apos;salary&apos;</span>, period)
    <span class="hljs-keyword">return</span> select(
        [salary &lt;= <span class="hljs-number">500</span>, salary &lt;= <span class="hljs-number">1000</span>, salary &lt;= <span class="hljs-number">1500</span>, salary &gt; <span class="hljs-number">1500</span>],
        [<span class="hljs-number">200</span>, <span class="hljs-number">100</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>],
        )
</code></pre>
<p>If the first condition is met, the first value will be assigned, without considering the other conditions. For instance, if <code>salary = 100</code>, <code>salary &lt;= 500</code> is true and therefore <code>200</code> will be assigned. It doesn&apos;t matter that <code>salary &lt;= 1000</code> is also true.</p>
<p>If the first condition is not met, then only the second condition will be considered, and so on. If no condition is met, <code>0</code> will be assigned.</p>
<h3 id="complex-conditions">Complex conditions</h3>
<p>If no <a href="https://docs.scipy.org/doc/numpy/reference/routines.math.html#sums-products-differences" target="_blank">NumPy function</a> helps you express a very specific condition, you can code arbitrary conditions using <code>*</code> instead of <code>and</code>, and <code>+</code> instead of <code>or</code>.</p>
<p>For instance, let&apos;s consider that a person will be granted <code>200</code> if either:</p>
<ul>
<li>they are more than 25 <em>and</em> make less than <code>1000</code> per month;</li>
<li>or they are disabled.</li>
</ul>
<pre><code class="lang-py"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">formula</span><span class="hljs-params">(person, period)</span>:</span>
    condition_age = person(<span class="hljs-string">&apos;age&apos;</span>) &gt;= <span class="hljs-number">25</span>
    condition_salary = person(<span class="hljs-string">&apos;salary&apos;</span>, period) &lt; <span class="hljs-number">1000</span>
    condition_handicap = person(<span class="hljs-string">&apos;handicap&apos;</span>)
    condition = condition_age * condition_salary + condition_handicap
    <span class="hljs-keyword">return</span> condition * <span class="hljs-number">200</span>
</code></pre>
<blockquote>
<p>You should always use <a href="https://docs.scipy.org/doc/numpy/reference/routines.math.html#sums-products-differences" target="_blank">NumPy function</a> such as <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html" target="_blank"><code>where</code></a> and <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.select.html" target="_blank"><code>select</code></a> when they are relevant: logical operations using arithmetic operators should be used as last resort as they are not very readable.</p>
</blockquote>
<h2 id="arithmetic-operations">Arithmetic operations</h2>
<p>Basic arithmetic operations such as <code>+</code> or <code>*</code> behave the same way on vectors than on numbers, you can thus use them in OpenFisca formulas. However, some operations must be adapted.</p>
<table>
<thead>
<tr>
<th>Scalar (won&apos;t work)</th>
<th>Vectorial alternative</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>min</code></td>
<td><code>min_(x,y)</code></td>
</tr>
<tr>
<td><code>max</code></td>
<td><code>max_(x,y)</code></td>
</tr>
<tr>
<td><code>round</code></td>
<td><code>round_(x,y)</code></td>
</tr>
</tbody>
</table>
<h2 id="boolean-operations">Boolean operations</h2>
<table>
<thead>
<tr>
<th>Scalar (won&apos;t work)</th>
<th>Vectorial alternative</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>not</code></td>
<td><code>not_(x,y)</code></td>
</tr>
<tr>
<td><code>and</code></td>
<td><code>x * y</code></td>
</tr>
<tr>
<td><code>or</code></td>
<td><code>x + y</code></td>
</tr>
</tbody>
</table>
<h2 id="string-concatenation">String concatenation</h2>
<p>The <code>+</code> operator, as well as formatted <code>%s</code> strings for concatenation should be replaced by a call to <code>concat(x, y)</code>.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../coding-the-legislation/20_input_variables.html" class="navigation navigation-prev " aria-label="Previous page: Introducing an input variable"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../coding-the-legislation/35_periods.html" class="navigation navigation-next " aria-label="Next page: Periods"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-github/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-anchorjs/anchor-style.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"github":{"url":"https://github.com/openfisca/openfisca-doc"},"edit-link":{"base":"https://github.com/openfisca/openfisca-doc/edit/master","label":"Edit This Page"},"anchorjs":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
